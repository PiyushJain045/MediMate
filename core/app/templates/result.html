{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - Health-AI</title>
    <link rel="stylesheet" href="{% static 'results.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="{% url 'home_page' %}" class="navbar-brand">MediMate</a>
            <div class="navbar-menu">
                <a href="{% url 'home_page' %}">Home</a>
                <a href="{% url 'home' %}">Diagnosis</a>
                <a href="{% url 'calendar' %}">Calendar</a>
                <a href="{% url 'profile' %}">Profile</a>
                {% if user.is_authenticated %}
                    <a href="{% url 'account_logout' %}" class="navbar-profile-button">Logout</a>
                {% else %}
                    <a href="{% url 'account_login' %}" class="navbar-profile-button">Login</a>
                {% endif %}
            </div>
            <button id="mobile-menu-button" class="mobile-menu-button">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
        <div id="mobile-menu" class="mobile-menu">
            <a href="{% url 'home_page' %}">Home</a>
            <a href="{% url 'home' %}">Diagnosis</a>
            <a href="{% url 'calendar' %}">Calendar</a>
            <a href="{% url 'profile' %}">Profile</a>
             {% if user.is_authenticated %}
                <a href="{% url 'account_logout' %}" class="navbar-profile-button">Logout</a>
            {% else %}
                <a href="{% url 'account_login' %}" class="navbar-profile-button">Login</a>
            {% endif %}
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <!-- ADDED ID HERE -->
        <p id="loading-text">Finding specialists...</p>
    </div>

    <!-- Main Content -->
    <main class="container">
        <div class="results-card">
            <header class="results-header">
                <p>AI Preliminary Assessment</p>
                <h1 class="capitalize">
                    {% if result %}{{ result }}{% elif skin_result %}{{ skin_result }}{% else %}No Result Found{% endif %}
                </h1>
            </header>

            {% if advice_data %}
            <div class="advice-section">
                <div class="category-banner {{ advice_data.category_color_class }}">
                    {{ advice_data.assessment_category }}
                </div>
                <p class="advice-text">{{ advice_data.advice|linebreaksbr }}</p>
            </div>
            {% elif advice %}
             <div class="advice-section">
                <div class="category-banner category-green">
                    Self Care
                </div>
                <p class="advice-text">{{ advice|linebreaksbr }}</p>
            </div>
            {% endif %}

            <div class="next-step-section">
                <h2>Next Step</h2>
                <p>Find a specialist near you for a professional consultation.</p>
                <form id="nearby-doctors-form" method="POST" action="{% url 'nearby_doctors' %}">
                    {% csrf_token %}
                    {% if result %}
                        <input type="hidden" name="disease_name" value="{{ result }}">
                    {% elif skin_result %}
                        <input type="hidden" name="disease_name" value="{{ skin_result }}">
                    {% endif %}
                    
                    <!-- ADDED HIDDEN INPUTS FOR COORDINATES -->
                    <input type="hidden" name="latitude" id="latitude-input">
                    <input type="hidden" name="longitude" id="longitude-input">

                    <!-- ADDED ID TO BUTTON -->
                    <button type="submit" id="find-doctors-btn" class="button-primary">Look For Nearby Doctors</button>
                </form>
            </div>
        </div>

        <footer class="disclaimer">
            <p><strong>Important Disclaimer:</strong> The information provided by MediMate is generated by an artificial intelligence model and is for informational purposes only. It is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of a qualified healthcare provider for any medical concerns.</p>
        </footer>
    </main>

    <script>
        // --- Navigation Menu Logic ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.style.display = mobileMenu.style.display === 'block' ? 'none' : 'block';
        });

        // --- COMBINED Geolocation and Form Submission Logic ---
        const nearbyDoctorsForm = document.getElementById('nearby-doctors-form');
        const findDoctorsBtn = document.getElementById('find-doctors-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        nearbyDoctorsForm.addEventListener('submit', function(event) {
            // 1. Prevent the form from submitting immediately
            event.preventDefault();
            
            findDoctorsBtn.disabled = true;
            loadingText.textContent = 'Getting your location...';
            loadingOverlay.classList.add('visible');

            // 2. Check if Geolocation is available
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                loadingOverlay.classList.remove('visible');
                findDoctorsBtn.disabled = false;
                return;
            }

            // 3. Get the user's current position
            navigator.geolocation.getCurrentPosition(success, error);

            function success(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // 4. Populate the hidden form fields
                document.getElementById('latitude-input').value = latitude;
                document.getElementById('longitude-input').value = longitude;

                loadingText.textContent = 'Finding specialists...';

                // 5. Submit the form
                nearbyDoctorsForm.submit();
            }

            function error() {
                alert("Unable to retrieve your location. Please ensure you have enabled location services for your browser and try again.");
                loadingOverlay.classList.remove('visible');
                findDoctorsBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
